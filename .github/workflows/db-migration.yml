name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment for migration"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      command:
        description: "Alembic command to run"
        required: true
        default: "upgrade"
        type: choice
        options:
          - upgrade
          - downgrade
      revision:
        description: "Target revision (use 'head' for latest)"
        required: true
        default: "head"
        type: string

env:
  REGISTRY: us-central1-docker.pkg.dev
  BACKEND_IMAGE_NAME: release-manager/backend
  GCP_REGION: us-central1

jobs:
  db-migration:
    name: Run Database Migration
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Set environment variables
        run: |
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}" >> $GITHUB_ENV
            echo "IMAGE_NAME=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_IMAGE_NAME }}:latest" >> $GITHUB_ENV
          else
            echo "DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}" >> $GITHUB_ENV
            echo "IMAGE_NAME=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_IMAGE_NAME }}:latest" >> $GITHUB_ENV
          fi

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Create migration runner container
        run: |
          docker create \
            --name migration-runner \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            ${{ env.IMAGE_NAME }} \
            alembic ${{ github.event.inputs.command }} ${{ github.event.inputs.revision }}

      - name: Run database migration
        run: docker start -ai migration-runner

      - name: Check migration status
        run: |
          if [ $? -eq 0 ]; then
            echo "Migration completed successfully"
          else
            echo "Migration failed"
            exit 1
          fi

      - name: Verify migration
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          docker run --rm \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            ${{ env.IMAGE_NAME }} \
            alembic current

      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Database Migration Status",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":database: Database Migration - ${{ github.event.inputs.environment }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ github.event.inputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Command:*\n${{ github.event.inputs.command }} ${{ github.event.inputs.revision }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ job.status == 'success' && ':white_check_mark: Successful' || ':x: Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow>"
                    }
                  ]
                }
              ]
            }
